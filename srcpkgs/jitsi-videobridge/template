# Template file for 'jitsi-videobridge'
pkgname=jitsi-videobridge
version=4548
revision=1
archs=noarch
hostmakedepends="openjdk8-jre openjdk8 apache-maven>=3.5.0 unzip"
depends="openjdk8-jre"
short_desc="jitsi-videobridge"
maintainer="Mathieu Kerjouan"
license="Apache-2.0"
homepage="https://www.jitsi.org"
distfiles="https://github.com/jitsi/jitsi-videobridge/archive/stable/jitsi-meet_${version}.zip"
checksum=9fb02708648d9c254b2ca4459b5427b13e4ca097cae8198ef4ec415486e106e6
wrksrc="jitsi-videobridge-stable-jitsi-meet_${version}"
conf_files="/etc/sv/jitsi-videobridge/conf"

do_build() {
	export JAVA_HOME=/usr/lib/jvm/java-1.8-openjdk/jre
	mvn -B package --file pom.xml
}

post_build() {
	unzip target/jitsi-videobridge-2.1-SNAPSHOT-archive.zip
}

do_install() {
	vmkdir usr/share/jitsi-videobridge
	vcopy jitsi-videobridge-2.1-SNAPSHOT/jvb.sh usr/share/jitsi-videobridge
	vcopy jitsi-videobridge-2.1-SNAPSHOT/jitsi-videobridge.jar usr/share/jitsi-videobridge
	vcopy jitsi-videobridge-2.1-SNAPSHOT/lib usr/share/jitsi-videobridge

	vmkdir usr/share/jitsi-videobridge/sysctl.d
	vcopy config/20-jvb-udp-buffers.conf usr/share/jitsi-videobridge/sysctl.d

	vmkdir usr/share/jitsi-videobridge/logrotate.d
	vcopy config/logrotate usr/share/jitsi-videobridge/logrotate.d/jitsi-videobridge

	vmkdir etc/jitsi/videobridge
	vcopy config/callstats-java-sdk.properties etc/jitsi/videobridge/
	vcopy config/log4j2.xml etc/jitsi/videobridge/
	vcopy lib/logging.properties etc/jitsi/videobridge/

	vcopy doc usr/share/jitsi-videobridge/

	vman debian/manpage.1 jitsi-videobridge.1

	vsv jitsi-videobridge
}
